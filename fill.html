<!DOCTYPE html>
<html lang="de">
    <head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Fill form</title>
		<link rel="icon" href="favicon.ico" type="image/x-icon">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans" >
		<link rel="stylesheet" href="css/form.css">
        <script src="js/collect.js"></script>
	</head>
    <body onload="collect()">
        <script>
            function fillBooklet() { 
                
                // performance
                section = 
                    { id: "performance", legend: "Aufführung", fields: [
                        { label: "Oper", value: "", name: "opera", gnd: "" },
                        { label: "Komponist", value: "", name: "composer", gnd: "" },
                        { label: "Librettist", value: "", name: "libretto", gnd: "" },
                        { label: "Uraufführung (Jahr)", value: "", name: "firstPerformance", gnd: "" },
                        { label: "Produktion", value: "", name: "production", gnd: "" },
                        { label: "Bühne", value: "", name: "stage", gnd: "" },
                        { label: "Ort", value: "", name: "place", gnd: "" },
                        { label: "Premiere (Jahr)", value: "", name: "premiere", p: "", gnd: "" },
                        { label: "Inszenierung", value: "", name: "director", gnd: ""},
                        { label: "Musikal. Leitung", value: "", name: "conductor", gnd: ""},
                        { label: "Dramaturgie", value: "", name: "dramatist", gnd: ""},
                        { label: "Orchester", value: "", name: "orchestra", gnd: ""}
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="form-container"></div>`;
                container = fieldset.querySelector(".form-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>${field.label}</label>
                        <input type="text" name="${field.name}" value="${field.value}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="${field.name}GND" value="${field.gnd}"></input>`;
                });
                const opInput = fieldset.querySelector("input[name='opera']");
                opInput.setAttribute("list", "operas");
                booklet.appendChild(fieldset);

                // cast list section
                section = 
                    { id: "cast-list", legend: "Besetzung", fields: [
                        { role: "", artist: "", gnd: "" }                       
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="cast-list-container"></div>`;
                container = fieldset.querySelector(".cast-list-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>Rolle</label>
                        <input type="text" name="role" value="${field.role}"></input>
                        <label>Künstler</label>
                        <input type="text" name="artist" value="${field.artist}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="artistGND" value="${field.gnd}"></input>`     
                });
                addNewCastLine = document.createElement("input");
                Object.assign(addNewCastLine, {type: "button", name: "add_castline", value: "+"});
                container.appendChild(addNewCastLine);
                addNewCastLine.addEventListener("click", addCastLine);
                booklet.appendChild(fieldset);

                // staging-related texts section
                section = 
                    { id: "staging-related", legend: "Texte zur Aufführung", fields: [
                        { author: "", gnd: "", title: "", paragraphs: [""] }                       
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="form-container"></div>`;
                container = fieldset.querySelector(".form-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>Autor</label>
                        <input type="text" name="Author" value="${field.author}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="GND" value="${field.gnd}"></input>
                        <label>Titel</label>
                        <input type="text" name="Title" value="${field.title}"></input>
                        <p class="right-text"></p>`;
                    field.paragraphs.forEach(paragraph => {
                        container.innerHTML += `
                            <label>Absatz</label>
                            <textarea class="full-text"></textarea>`
                    });
                });
                addNewPara = document.createElement("input");
                Object.assign(addNewPara, {type: "button", name: "add_para", value: "+"});
                container.appendChild(addNewPara);
                addNewPara.addEventListener("click", addParagraph);

                addNewText = document.createElement("input");
                Object.assign(addNewText, {type: "button", name: "add_text", value: "weiterer Text"});
                addNewText.addEventListener("click", addText);
                fieldset.appendChild(addNewText);
                booklet.appendChild(fieldset);

                // story-related texts section
                section = 
                    { id: "story-related", legend: "Texte zur Handlung", fields: [
                        { author: "", gnd: "", title: "", paragraphs: [""] }                       
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="form-container"></div>`;
                container = fieldset.querySelector(".form-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>Autor</label>
                        <input type="text" name="Author" value="${field.author}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="GND" value="${field.gnd}"></input>
                        <label>Titel</label>
                        <input type="text" name="Title" value="${field.title}"></input>
                        <p class="right-text"></p>`;
                    field.paragraphs.forEach(paragraph => {
                        container.innerHTML += `
                            <label>Absatz</label>
                            <textarea class="full-text"></textarea>`
                    });
                });
                addNewPara = document.createElement("input");
                Object.assign(addNewPara, {type: "button", value: "+"});
                container.appendChild(addNewPara);
                addNewPara.addEventListener("click", addParagraph);

                addNewText = document.createElement("input");
                Object.assign(addNewText, {type: "button", value: "weiterer Text"});
                fieldset.appendChild(addNewText);
                addNewText.addEventListener("click", addText);
                booklet.appendChild(fieldset);

                // music-related texts section
                section = 
                    { id: "music-related", legend: "Texte zur Musik", fields: [
                        { author: "", gnd: "", title: "", paragraphs: [""] }                       
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="form-container"></div>`;
                container = fieldset.querySelector(".form-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>Autor</label>
                        <input type="text" name="Author" value="${field.author}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="GND" value="${field.gnd}"></input>
                        <label>Titel</label>
                        <input type="text" name="Title" value="${field.title}"></input>
                        <p class="right-text"></p>`;
                    field.paragraphs.forEach(paragraph => {
                        container.innerHTML += `
                            <label>Absatz</label>
                            <textarea class="full-text"></textarea>`
                    });
                });
                addNewPara = document.createElement("input");
                Object.assign(addNewPara, {type: "button", value: "+"});
                container.appendChild(addNewPara);
                addNewPara.addEventListener("click", addParagraph);

                addNewText = document.createElement("input");
                Object.assign(addNewText, {type: "button", value: "weiterer Text"});
                addNewText.addEventListener("click", addText);
                fieldset.appendChild(addNewText);
                booklet.appendChild(fieldset);

                // historic texts section 
                section = 
                    { id: "historic", legend: "Historische Texte", fields: [
                        { author: "", gnd: "", title: "", paragraphs: [""] }                       
                    ] };
                fieldset = document.createElement("fieldset");
                fieldset.setAttribute("id", section.id);
                fieldset.innerHTML = `<legend>${section.legend}</legend><div class="form-container"></div>`;
                container = fieldset.querySelector(".form-container");
                section.fields.forEach(field => {
                    container.innerHTML += `
                        <label>Autor</label>
                        <input type="text" name="Author" value="${field.author}"></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="GND" value="${field.gnd}"></input>
                        <label>Titel</label>
                        <input type="text" name="Title" value="${field.title}"></input>
                        <p class="right-text"></p>`;
                    field.paragraphs.forEach(paragraph => {
                        container.innerHTML += `
                            <label>Absatz</label>
                            <textarea class="full-text"></textarea>`
                    });    
                });
                addNewPara = document.createElement("input");
                Object.assign(addNewPara, {type: "button", value: "+"});
                container.appendChild(addNewPara);
                addNewPara.addEventListener("click", addParagraph);
                
                addNewText = document.createElement("input");
                Object.assign(addNewText, {type: "button", value: "weiterer Text"});
                fieldset.appendChild(addNewText);
                addNewText.addEventListener("click", addText);
                booklet.appendChild(fieldset);

                // add save button
                button = document.createElement("div")
                button.innerHTML += `<input type="button" id="saveButton" value="Speichern" ></input>`
                booklet.appendChild(button);

                body.appendChild(booklet);

                // add event listener to opera input field
                document.querySelector("input[name='opera']").addEventListener("change", function() {
                    const op = document.querySelector("input[name='opera']").value;
                    console.log (op);
                    const idx = operas.findIndex (opera => opera[0] === op);
                    console.log (idx);
                    const composer = operas[idx][1];
                    const firstPerf = operas[idx][2];
                    const libretto = operas[idx][3];
                    document.querySelector("input[name='composer']").value = composer;
                    document.querySelector("input[name='firstPerformance']").value = firstPerf;
                    document.querySelector("input[name='libretto']").value = libretto;
                });

                // add event handler to save button
                document.getElementById("saveButton").addEventListener("click", saveFile); 
            }

            function addCastLine() {
                const labelRole = document.createElement("label");
                const role = document.createElement("input");
                Object.assign(role, {type: "text", name: "role"});
                const labelArtist = document.createElement("label");
                const artist = document.createElement("input");
                Object.assign(artist, {type: "text", name: "artist"});
                const labelGND = document.createElement("label");
                const gnd = document.createElement("input");
                Object.assign(gnd, {type: "text", name: "artistGND"});
                const button = document.createElement("input");
                button.setAttribute("type", "button");
                button.setAttribute("name", "add_castline");
                button.setAttribute("value", "+");
                button.addEventListener("click", addCastLine);
                const clicked = event.target;
                clicked.insertAdjacentElement("afterend", labelRole);
                labelRole.insertAdjacentElement("afterend", role);
                role.insertAdjacentElement("afterend", labelArtist);
                labelArtist.insertAdjacentElement("afterend", artist);
                artist.insertAdjacentElement("afterend", labelGND);
                labelGND.insertAdjacentElement("afterend", gnd);
                gnd.insertAdjacentElement("afterend", button);
            }

            function addParagraph() {
                const label = document.createElement("label");
                const paragraph = document.createElement("textarea");
                paragraph.classList.add("full-text");
                const button = document.createElement("input");
                button.setAttribute("type", "button");
                button.setAttribute("value", "+");
                button.addEventListener("click", addParagraph);
                const clicked = event.target;
                clicked.insertAdjacentElement("afterend", label);
                label.insertAdjacentElement("afterend", paragraph);
                paragraph.insertAdjacentElement("afterend", button);
            }

            function addText() {
                const cont = document .createElement("div");
                cont.innerHTML += `
                        <label>Autor</label>
                        <input type="text" name="Author" value=""></input>
                        <label class="GND-label">GND-ID</label>
                        <input type="text" name="GND" value=""></input>
                        <label>Titel</label>
                        <input type="text" name="Title" value=""></input>
                        <p class="right-text"></p>
                        <label>Absatz</label>
                        <textarea class="full-text"></textarea>`;
                cont.classList.add("form-container");
                const buttonPara = document.createElement("input");
                buttonPara.setAttribute("type", "button");
                buttonPara.setAttribute("value", "+");
                cont.appendChild(buttonPara);
                buttonPara.addEventListener("click", addParagraph);
                const button = document.createElement("input");
                button.setAttribute("type", "button");
                button.setAttribute("value", "weiterer Text");
                button.addEventListener("click", addText);
                const clicked = event.target;
                clicked.insertAdjacentElement("afterend", cont);
                cont.insertAdjacentElement("afterend", button);
            }

            function saveFile() {
                // collect text input from performance section
                const opera = document.querySelector("input[name='opera']").value;
                const operaGND = document.querySelector("input[name='operaGND']").value;
                const composer = document.querySelector("input[name='composer']").value;
                const composerGND = document.querySelector("input[name='composerGND']").value;
                const libretto = document.querySelector("input[name='libretto']").value;
                const librettoGND = document.querySelector("input[name='librettoGND']").value;
                const firstPerformance = document.querySelector("input[name='firstPerformance']").value;
                const production = document.querySelector("input[name='production']").value;
                const productionGND = document.querySelector("input[name='productionGND']").value;
                const stage = document.querySelector("input[name='stage']").value;
                const stageGND = document.querySelector("input[name='stageGND']").value;
                const place = document.querySelector("input[name='place']").value;
                const placeGND = document.querySelector("input[name='placeGND']").value;
                const premiere = document.querySelector("input[name='premiere']").value;
                const director = document.querySelector("input[name='director']").value;
                const directorGND = document.querySelector("input[name='directorGND']").value;
                const conductor = document.querySelector("input[name='conductor']").value;
                const conductorGND = document.querySelector("input[name='conductorGND']").value;
                const dramatist = document.querySelector("input[name='dramatist']").value;
                const dramatistGND = document.querySelector("input[name='dramatistGND']").value;
                const orchestra = document.querySelector("input[name='orchestra']").value;
                const orchestraGND = document.querySelector("input[name='orchestraGND']").value;

                // collect text input from cast list section
                const roles = document.querySelectorAll("input[name='role']");
                const artists = document.querySelectorAll("input[name='artist']");
                const artistGNDs = document.querySelectorAll("input[name='artistGND']");

                // init XML parser and create top-level XML elements
                const parser = new DOMParser();
                const xml = parser.parseFromString("<booklet></booklet>", "text/xml");
                const booklet = xml.querySelector("booklet");
                const performance = xml.createElement("performance");
                const castList = xml.createElement("castList");
                const stagingRelated = xml.createElement("stagingRelated");
                const storyRelated = xml.createElement("storyRelated");
                const musicRelated = xml.createElement("musicRelated");
                const historic = xml.createElement("historic");

                // performance
                performance.innerHTML = `
                    <opera>
                        <operaTitle>${opera}</operaTitle>
                        <operaGND>${operaGND}</operaGND>
                    </opera>
                    <composer>
                        <composerName>${composer}</composerName>
                        <composerGND>${composerGND}</composerGND>
                    </composer>
                    <libretto>
                        <librettoName>${libretto}</librettoName>
                        <librettoGND>${librettoGND}</librettoGND>
                    </libretto>
                    <firstPerformance>${firstPerformance}</firstPerformance>
                    <production>
                        <productionName>${production}</productionName>
                        <productionGND>${productionGND}</productionGND>
                    </production>
                    <stage>
                        <stageName>${stage}</stageName>
                        <stageGND>${stageGND}</stageGND>
                    </stage>
                    <place>
                        <placeName>${place}</placeName>
                        <placeGND>${placeGND}</placeGND>
                    </place>
                    <premiere>${premiere}</premiere>
                    <director>
                        <directorName>${director}</directorName>
                        <directorGND>${directorGND}</directorGND>
                    </director>
                    <conductor>
                        <conductorName>${conductor}</conductorName>
                        <conductorGND>${conductorGND}</conductorGND>
                    </conductor>
                    <dramatist>
                        <dramatistName>${dramatist}</dramatistName>
                        <dramatistGND>${dramatistGND}</dramatistGND>
                    </dramatist>
                    <orchestra>
                        <orchestraName>${orchestra}</orchestraName>
                        <orchestraGND>${orchestraGND}</orchestraGND>    
                    </orchestra>`;
                booklet.appendChild(performance);

                // cast list
                roles.forEach((role, index) => {
                    console.log (role.value)
                    const cast = xml.createElement("cast");
                    cast.innerHTML = `
                        <role>${roles[index].value}</role>
                        <artist>${artists[index].value}</artist>
                        <artistGND>${artistGNDs[index].value}</artistGND>`;
                    castList.appendChild(cast);
                });
                booklet.appendChild(castList);

                // staging-related texts
                const stagingTexts = document.querySelectorAll("#staging-related .form-container");
                stagingTexts.forEach(text => {
                    const textElement = xml.createElement("text");
                    textElement.innerHTML = `
                        <author>${text.querySelector("input[name='Author']").value}</author>
                        <authorGND>${text.querySelector("input[name='GND']").value}</authorGND>
                        <title>${text.querySelector("input[name='Title']").value}</title>`;
                    const paragraphs = text.querySelectorAll("textarea");
                    paragraphs.forEach((para, index) => {
                        const paragraph = xml.createElement("paragraph");
                        paragraph.innerHTML = para.value;
                        textElement.appendChild(paragraph);
                    });
                    stagingRelated.appendChild(textElement);
                });
                booklet.appendChild(stagingRelated);

                // story-related texts
                const storyTexts = document.querySelectorAll("#story-related .form-container");
                storyTexts.forEach(text => {
                    const textElement = xml.createElement("text");
                    textElement.innerHTML = `
                        <author>${text.querySelector("input[name='Author']").value}</author>
                        <authorGND>${text.querySelector("input[name='GND']").value}</authorGND>
                        <title>${text.querySelector("input[name='Title']").value}</title>`;
                    const paragraphs = text.querySelectorAll("textarea");
                    paragraphs.forEach((para, index) => {
                        const paragraph = xml.createElement("paragraph");
                        paragraph.innerHTML = para.value;
                        textElement.appendChild(paragraph);
                    });
                    storyRelated.appendChild(textElement);
                });
                booklet.appendChild(storyRelated);

                // music-related texts
                const musicTexts = document.querySelectorAll("#music-related .form-container");
                musicTexts.forEach(text => {
                    const textElement = xml.createElement("text");
                    textElement.innerHTML = `
                        <author>${text.querySelector("input[name='Author']").value}</author>
                        <authorGND>${text.querySelector("input[name='GND']").value}</authorGND>
                        <title>${text.querySelector("input[name='Title']").value}</title>`;
                    const paragraphs = text.querySelectorAll("textarea");
                    paragraphs.forEach((para, index) => {
                        const paragraph = xml.createElement("paragraph");
                        paragraph.innerHTML = para.value;
                        textElement.appendChild(paragraph);
                    });
                    musicRelated.appendChild(textElement);
                });
                booklet.appendChild(musicRelated);

                // historic texts
                const historicTexts = document.querySelectorAll("#historic .form-container");
                historicTexts.forEach(text => {
                    const textElement = xml.createElement("text");
                    textElement.innerHTML = `
                        <author>${text.querySelector("input[name='Author']").value}</author>
                        <authorGND>${text.querySelector("input[name='GND']").value}</authorGND>
                        <title>${text.querySelector("input[name='Title']").value}</title>`;
                    const paragraphs = text.querySelectorAll("textarea");
                    paragraphs.forEach((para, index) => {
                        const paragraph = xml.createElement("paragraph");
                        paragraph.innerHTML = para.value;
                        textElement.appendChild(paragraph);
                    });
                    historic.appendChild(textElement);
                });
                booklet.appendChild(historic);

                // preliminary solution for file name creation
                const sOpera = "Holländer";
                const sComposer = "Wagner";
                const sPlace = "Düsseldorf";
                const sYear = "2000";

                // save booklet file to download folder
                const xmlString = new XMLSerializer().serializeToString(xml);
                const blob = new Blob([xmlString], { type: "text/xml" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                alert (`${sYear}-${sOpera}-${sComposer}-${sPlace}.xml`)
                a.download = `${sYear}-${sOpera}-${sComposer}-${sPlace}.xml`;
                a.click();

                // save booklet data to GitHub repo
                const repo = "https://api.github.com/repos/nluttenberger/orpheana/contents/";
            }
        </script>
    </body>
</html>